---

copyright:
  years: 2017
lastupdated: "2017-06-02"

---

# Using the ELK Sample

Configure the ELK Sample to enable monitoring of your logging and tracing metrics generated by the Liberty server, using Elasticsearch, Logstash, and Kibana.

## Before you begin

* [Deploy the Microservice Builder fabric](https://github.ibm.com/liber8/docs/blob/vnext/installing_fabric_task.md) using your _IBM Spectrum Conductor for Containers_ dashboard. The link needs to be modified to point to the fabric installation page.

* [Deploy the Microservice Builder ELK Sample](installing_sample_elk_task.md) using your _IBM Spectrum Conductor for Containers_ dashboard.

* Install the `logstashcollector-1.0` feature on the Liberty runtime.

 In your **server.xml** file, add the following snippet to your feature manager:

 ```
 <featureManager>
     <feature>logstashCollector-1.0</feature>
 </featureManager>
 ```

 If you are using the Dockerfile created by `bx dev`, this will be sufficient to cause the feature to be installed when the Docker image is built. If not, add the following snippet to your Dockerfile to explictly install the feature:

 ```
 RUN installUtility install --acceptLicense logstashCollector-1.0
 ```

## Configure a Liberty server or a Liberty service

As part of the sample deployment, two more Kubernetes secrets and one more Kubernetes configuration map are created. These secrets and configuration map are used alongside the secrets deployed by the _fabric_ to configure a Liberty server to forward all logging and tracing data to the ELK sample.

When you deploy the Microservice Builder ELK Sample, it creates the following two Kubernetes secrets.
* __mb-server-key__: The secret contains the `server.key` file, pulled from the **mb-keystore**, to enable SSL communication between the Logstash and Liberty servers.
* __mb-server-crt__: The secret contains the `server.crt` file, pulled from the **mb-keystore**, to enable SSL communication between the Logstash and Liberty servers.

When you deploy the Microservice Builder ELK Sample, it creates the following Kubernetes configuration map.
* __liberty-logging-config__: The configuration map contains the `server.xml` file overrides. These overrides configure the Liberty server or the Liberty service to use the certificates that are generated from the _fabric_, as well as to enable the features required for forwarding logs and trace messages.

-----------

1. Ensure that the Kubernetes secrets exist. Run the following **kubectl** command and find the _mb-truststore_, _mb-truststore_, _mb-keystore_ and _mb-keystore-password_ Kubernetes secrets in the list:  

     ``kubectl get secrets``
2. Ensure that the configuration map exists. Run the following **kubectl** command and find the configuration map value of  _liberty-config_ in the list:  

     ``kubectl get configmap``  

3. In your Liberty server or Liberty service **deployment.yaml** file, create the volumes onto which the secrets and configuration map will be mounted. **USE THE PROVIDED SNIPPET EXACTLY AS IS.**

 ```bash
volumes:
 - name: keystores
   secret:
     secretName: mb-keystore
 - name: truststores
   secret:
     secretName: mb-truststore
 - name: liberty-logging-config
   configMap:
     name: liberty-logging-config
     items:
       - key: keystore.xml
         path: defaults/keystore.xml
       - key: logging.xml
         path: defaults/logging.xml
  ```

4. In your Liberty server or Liberty service **deployment.yaml** file, mount the created volumes. **USE THE PROVIDED SNIPPET EXACTLY AS IS.**  

 ```bash
volumeMounts:
 - name: keystores
   mountPath: /etc/wlp/config/keystore
   readOnly: true
 - name: truststores
   mountPath: /etc/wlp/config/truststore
   readOnly: true
 - name: liberty-logging-config
   mountPath: /config/configDropins
 ```

5. In your Liberty server or Liberty service **deployment.yaml** file, specify the enviroment variables that reference the Kubernetes secrets. **USE THE PROVIDED SNIPPET EXACTLY AS IS.**  

 ```bash
env:
 - name: MB_KEYSTORE_PASSWORD
   valueFrom:
     secretKeyRef:
       name: mb-keystore-password
       key: password
 - name: MB_TRUSTSTORE_PASSWORD
   valueFrom:
     secretKeyRef:
       name: mb-truststore-password
       key: password
 ```


-------------------

The following snippet is an example of a sample Liberty deployment (**sample-deployment**) of a sample Liberty image (**sample-image**). The sample image uses the _mb-truststore_, _mb-truststore-password_, _mb-keystore_, and _mb-keystore-password_ Kubernetes secrets; the _MB_KEYSTORE_PASSWORD_ and _MB_TRUSTSTORE_PASSWORD_ environment variables; and the  _liberty-logging-config_ configuration map:

```bash
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
 name: sample
spec:
 replicas: 1
 template:
   metadata:
     labels:
       name: sample-deployment
   spec:
     containers:
     - name: sample
       image: sample-image
       env:
         - name: MB_KEYSTORE_PASSWORD
           valueFrom:
             secretKeyRef:
               name: mb-keystore-password
               key: password
         - name: MB_TRUSTSTORE_PASSWORD
           valueFrom:
             secretKeyRef:
               name: mb-truststore-password
               key: password
       volumeMounts:
         - name: keystores
           mountPath: /etc/wlp/config/keystore
           readOnly: true
         - name: truststores
           mountPath: /etc/wlp/config/truststore
           readOnly: true
         - name: liberty-logging-config
           mountPath: /config/configDropins
     volumes:
       - name: keystores
         secret:
           secretName: mb-keystore
       - name: truststores
         secret:
           secretName: mb-truststore
       - name: liberty-logging-config
         configMap:
           name: liberty-logging-config
           items:
             - key: keystore.xml
               path: defaults/keystore.xml
             - key: logging.xml
               path: defaults/logging.xml
---
apiVersion: v1
kind: Service
metadata:
 name: sample-service
spec:
 ports:
   - port: 9080
 selector:
   name: sample-deployment
 type: NodePort

```


## What to do next

You can use the Kibana browser client to view logging data sent to the ELK stack of the fabric.

1. Get the link to the _Kibana_ browser client by running the following commands:

 ```bash
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services logserver)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")  
  echo http://$NODE_IP:$NODE_PORT/
 ```
2. In the Kibana browser client, ensure that the index pattern is _Logstash-*_ by clicking **Settings > Indices**.

3. In the Kibana browser client, ensure that the Time-field name is set to _datetime_, and click **Create**.
The option to choose the Time-field name shows up on the main Kibana page after the ELK stack receives data.

4. The Liberty dashboards should already be uploaded as part of the sample deployment. Ensure that the dashboards are available for usage by clicking **Settings > Objects**. You can then click on the **View Dashboard Icon** for the listed dashboards object, or the **Dashboard** tab.
